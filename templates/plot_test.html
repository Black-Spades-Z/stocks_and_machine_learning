<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/styles/style.css">
    <title>Data Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Data Visualization</h1>
    <div id="plot"></div>
    <script>

        // Function to fetch data from backend and update plot
        function fetchDataAndUpdatePlot() {
            fetch('/get-forecast')
            .then(response => response.json())
            .then(data => {
                console.log(data);
                console.log(data[1]);
                console.log(data[1]['df']);

                for (let i = 0; i < data.length; i++) {

                    var df = data[i+1]['df'];
                    console.log(df);
                    const jsonArray = JSON.parse(df);

                    // Initialize arrays to store x and y values
                    const date = [];
                    const yHat = [];

                    // Extract data for plotting
                    jsonArray.forEach(entry => {
                        // Extract x-value (timestamp) and convert it to a Date object
                        const timestamp = new Date(entry.ds);
                        date.push(timestamp);

                        // Extract y-values (e.g., yhat, yhat_lower, yhat_upper, etc.)
                        // Change 'yhat' to the property you want to plot
                        const yValue = entry.yhat;
                        yHat.push(yValue);
                    });

                    // Now, you can use xValues and yValues for plotting
                    console.log('X values:', date);
                    console.log('Y values:', yHat);

                    const trace = {
                        x: date,
                        y: yHat,
                        type: 'scatter',
                        mode: 'lines+markers',
                        marker: {color: 'blue'},
                        line: {width: 2}
                    };

                    const layout = {
                        title: data[i+1]['stock_name'],
                        xaxis: {title: 'Date'},
                        yaxis: {title: 'Price'}
                    };
                    // Create a new div element for each plot
                    const div = document.createElement('div');
                    div.id = `plot_${i}`;  // Assign unique IDs to each div
                    div.className = 'charts_main_page';

                    document.body.appendChild(div);  // Append the div to the body or another container

                    // Plot the data in the new div
                    Plotly.newPlot(div.id, [trace], layout);
                    console.log('Working')
            }
            })
            .catch(error => console.error('Error fetching data:', error));
        }

        // Call the function to fetch data and update plot on page load
        window.onload = fetchDataAndUpdatePlot;
    </script>
</body>
</html>
